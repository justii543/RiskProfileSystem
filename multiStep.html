<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        /* Style the form */
        * {
            box-sizing: border-box;
        }

        #waterTable,
        #fireTable,
        #gasTable,
        #heightTable {
            font-family: Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }

        #waterTable td,
        #fireTable td,
        #gasTable td,
        #heightTable td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #waterTable tr:nth-child(even),
        #fireTable tr:nth-child(even),
        #gasTable tr:nth-child(even),
        #heightTable tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #water tr:hover,
        #fire tr:hover,
        #gas tr:hover,
        #height tr:hover {
            background-color: #ddd;
        }

        #waterTable th,
        #fireTable th,
        #gasTable th,
        #heightTable th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #394778;
            color: white;
        }

        body {
            background-color: #f1f1f1;
        }

        #regForm {
            background-color: #ffffff;
            margin: 100px auto;
            padding: 40px;
            width: 70%;
            min-width: 300px;
        }

        h1 {
            text-align: center;
        }

        /* Style the input fields */
        input {
            padding: 10px;
            width: 100%;
            font-size: 17px;
            font-family: Raleway;
            border: 1px solid #aaaaaa;
        }

        /* Mark input boxes that gets an error on validation: */
        input.invalid {
            background-color: #ffdddd;
        }

        /* Hide all steps by default: */
        .tab {
            display: none;
        }

        .tab-heading {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .tab-head {
            text-align: center;
            font-weight: bold;
            font-size: 30px;
        }

        button {
            background-color: #15954b;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            font-size: 17px;
            font-family: Raleway;
            cursor: pointer;
        }

        button:hover {
            opacity: 0.8;
        }

        #prevBtn {
            background-color: #bbbbbb;
        }

        #nextBtn{
            background-color: #04AA6D;
        }

        #submitBtn{
            background-color: #04AA6D;
        }

        /* Make circles that indicate the steps of the form: */
        .step {
            height: 15px;
            width: 15px;
            margin: 0 2px;
            background-color: #bbbbbb;
            border: none;
            border-radius: 50%;
            display: inline-block;
            opacity: 0.5;
        }

        /* Mark the active step: */
        .step.active {
            opacity: 1;
        }

        /* Mark the steps that are finished and valid: */
        .step.finish {
            background-color: #04AA6D;
        }
    </style>
</head>

<body>
    <form id="regForm" action="">
        <!-- <h1>Register</h1> -->
        <p class="tab-head">Register</p>
        <!-- One "tab" for each step in the form: -->
        <div class="tab">
            <p class="tab-heading">Details</p>
            <!-- <p><input placeholder="Name" id="profileName" oninput="this.className=''"></p> -->
            <p><input placeholder="Name" id="nameField" oninput="this.className = ''" readonly></p>
        </div>
        <div class="tab" id="water">
            <p class="tab-heading">Risk Category : Water</p>
            {% fetchxml water %}
            <fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
                <entity name="ris_risk">
                    <attribute name="ris_riskid" />
                    <attribute name="ris_name" />
                    <attribute name="createdon" />
                    <order attribute="ris_name" descending="false" />
                    <filter type="and">
                        <condition attribute="ris_riskcategory" operator="eq" uiname="Water" uitype="ris_riskcategory"
                            value="{023F6F42-1152-EE11-BE6F-002248286BDC}" />
                    </filter>
                </entity>
            </fetch>
            {% endfetchxml %}
            <table id="waterTable">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Risk Name</th>
                        <th>Measure</th>
                    </tr>
                </thead>
                <tbody>
                    {% assign rowCounter = 1 %}
                    {% for result in water.results.entities %}
                    <tr id="row{{ rowCounter }}">
                        <td>
                            <input type="checkbox" name="rowCheckbox{{ rowCounter }}" id="rowCheckbox{{ rowCounter }}"
                                data-category="Water">
                        </td>
                        <td>{{ result.ris_name }}</td>
                        <!-- <td>{{ result.ris_riskid }}</td>  -->
                        <!-- {% fetchxml watermeasure %}
                        <fetch version="1.0" mapping="logical" no-lock="false" distinct="true">
                            <entity name="ris_measures">
                                <attribute name="ris_measuresid" />
                                <attribute name="ris_name" />
                                <attribute name="createdon" />
                                <order attribute="ris_name" descending="false" />
                                <filter type="and">
                                    <condition attribute="ris_risk" operator="eq" value="{{result.ris_riskid}}" />
                                </filter>
                            </entity>
                        </fetch>
                        {% endfetchxml %} -->
                        {% fetchxml watermeasure %}
                        <fetch version="1.0" mapping="logical" distinct="true">
                            <entity name="ris_measures">
                                <attribute name="ris_measuresid" />
                                <attribute name="ris_name" />
                                <attribute name="createdon" />
                                <order attribute="ris_name" descending="false" />
                                <filter type="and">
                                    <condition attribute="ris_risk" operator="eq"
                                        value="{6f946488-1152-ee11-be6f-002248286bdc}"
                                        uiname="water depth greater than 5 ft" uitype="ris_risk" />
                                </filter>
                            </entity>
                        </fetch>
                        {% endfetchxml %}
                        <td>
                            <select class="dropdown" id="measureSelect{{ rowCounter }}"
                                name="measureSelect{{ rowCounter }}">
                                <option value="">Choose measure</option>
                                {% for measure in watermeasure.results.entities %}
                                <option value="{{ measure.ris_measuresid }}">
                                    {{ measure.ris_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    {% assign rowCounter = rowCounter | plus: 1 %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="tab" id="fire">
            <p class="tab-heading">Risk Category : Fire</p>
            {% fetchxml fires %}
            <fetch version="1.0" mapping="logical" no-lock="false" distinct="true">
                <entity name="ris_risk">
                    <attribute name="ris_riskid" />
                    <attribute name="ris_name" />
                    <attribute name="createdon" />
                    <order attribute="ris_name" descending="false" />
                    <filter type="and">
                        <condition attribute="ris_riskcategory" operator="eq"
                            value="{07d6b15b-1152-ee11-be6f-002248286bdc}" uiname="Fire" uitype="ris_riskcategory" />
                    </filter>
                </entity>
            </fetch>
            {% endfetchxml %}
            <table id="fireTable">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Risk Name</th>
                        <th>Measure</th>
                    </tr>
                </thead>
                <tbody>
                    {% assign rowCounter = 1 %}
                    {% for result in fires.results.entities %}
                    <tr id="row{{ rowCounter }}">
                        <td>
                            <input type="checkbox" name="rowCheckbox{{ rowCounter }}" id="rowCheckbox{{ rowCounter }}"
                                data-category="Fire">
                        </td>
                        <td>{{ result.ris_name }}</td>
                        <!-- <td>{{ result.ris_riskid }}</td> -->
                        {% fetchxml firemeasure %}
                        <fetch version="1.0" mapping="logical" no-lock="false" distinct="true">
                            <entity name="ris_measures">
                                <attribute name="ris_measuresid" />
                                <attribute name="ris_name" />
                                <attribute name="createdon" />
                                <order attribute="ris_name" descending="false" />
                                <filter type="and">
                                    <condition attribute="ris_risk" operator="eq" value="{{ result.ris_riskid}}"
                                        uiname="Temperature greater than 50 degrees" uitype="ris_risk" />
                                </filter>
                            </entity>
                        </fetch>
                        {% endfetchxml %}
                        <td>
                            <select id="measureSelect{{rowCounter}}" name="measureSelect{{ rowCounter }}">
                                <option value="">Choose measure</option>
                                {% for measure in firemeasure.results.entities %}
                                <option value="{{ measure.ris_measuresid }}">{{ measure.ris_name }}</option>
                                {% endfor %}
                            </select>

                        </td>
                    </tr>
                    {% assign rowCounter = rowCounter | plus: 1 %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="tab" id="gas">
            <p class="tab-heading">Risk Category : Gas</p>
            {% fetchxml gas %}
            <fetch version="1.0" mapping="logical" no-lock="false" distinct="true">
                <entity name="ris_risk">
                    <attribute name="ris_riskid" />
                    <attribute name="ris_name" />
                    <attribute name="createdon" />
                    <order attribute="ris_name" descending="false" />
                    <filter type="and">
                        <condition attribute="ris_riskcategory" operator="eq"
                            value="{c35a9b54-1152-ee11-be6f-002248286bdc}" uiname="Gas" uitype="ris_riskcategory" />
                    </filter>
                </entity>
            </fetch>
            {% endfetchxml %}
            <table id="gasTable">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Risk Name</th>
                        <th>Measure</th>
                    </tr>
                </thead>
                <tbody>
                    {% assign rowCounter = 1 %}
                    {% for result in gas.results.entities %}
                    <tr id="row{{ rowCounter }}">
                        <td>
                            <input type="checkbox" name="rowCheckbox{{ rowCounter }}" id="rowCheckbox{{ rowCounter }}"
                                data-category="Gas">
                        </td>
                        <td>{{ result.ris_name }}</td>
                        <!-- <td>{{ result.ris_riskid }}</td> -->
                        {% fetchxml gasmeasure %}
                        <fetch version="1.0" mapping="logical" no-lock="false" distinct="true">
                            <entity name="ris_measures">
                                <attribute name="ris_measuresid" />
                                <attribute name="ris_name" />
                                <attribute name="createdon" />
                                <order attribute="ris_name" descending="false" />
                                <filter type="and">
                                    <condition attribute="ris_risk" operator="eq" value="{{result.ris_riskid}}"
                                        uiname="Polluted gas" uitype="ris_risk" />
                                </filter>
                            </entity>
                        </fetch>
                        {% endfetchxml %}
                        <td>

                            <select id="measureSelect{{ rowCounter }}" name="measureSelect{{ rowCounter }}">
                                <option value="">Choose measure</option>
                                {% for measure in gasmeasure.results.entities %}
                                <option value="{{ measure.ris_measuresid }}">{{ measure.ris_name }}</option>
                                {% endfor %}
                            </select>

                        </td>
                    </tr>
                    {% assign rowCounter = rowCounter | plus: 1 %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="tab" id="height">
            <p class="tab-heading">Risk Category : Height</p>
            {% fetchxml height %}
            <fetch version="1.0" mapping="logical" no-lock="false" distinct="true">
                <entity name="ris_risk">
                    <attribute name="ris_riskid" />
                    <attribute name="ris_name" />
                    <attribute name="createdon" />
                    <order attribute="ris_name" descending="false" />
                    <filter type="and">
                        <condition attribute="ris_riskcategory" operator="eq"
                            value="{eb276c4e-1152-ee11-be6f-002248286bdc}" uiname="Height" uitype="ris_riskcategory" />
                    </filter>
                </entity>
            </fetch>
            {% endfetchxml %}
            <table id="heightTable">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Risk Name</th>
                        <th>Measure</th>
                    </tr>
                </thead>
                <tbody>
                    {% assign rowCounter = 1 %}
                    {% for result in height.results.entities %}
                    <tr id="row{{ rowCounter }}">
                        <td>
                            <input type="checkbox" name="rowCheckbox{{ rowCounter }}" id="rowCheckbox{{ rowCounter }}"
                                data-category="Height">
                        </td>
                        <td>{{ result.ris_name }}</td>
                        <!-- <td>{{ result.ris_riskid }}</td> -->
                        {% fetchxml heightmeasure %}
                        <fetch version="1.0" mapping="logical" no-lock="false" distinct="true">
                            <entity name="ris_measures">
                                <attribute name="ris_measuresid" />
                                <attribute name="ris_name" />
                                <attribute name="createdon" />
                                <order attribute="ris_name" descending="false" />
                                <filter type="and">
                                    <condition attribute="ris_risk" operator="eq" value="{{result.ris_riskid}}"
                                        uiname="Temperature greater than 50 degrees" uitype="ris_risk" />
                                </filter>
                            </entity>
                        </fetch>
                        {% endfetchxml %}
                        <td>
                            <select id="measureSelect{{ rowCounter}}" name="measureSelect{{ rowCounter }}">
                                <option value="">Choose measure</option>
                                {% for measure in heightmeasure.results.entities %}
                                <option value="{{ measure.ris_measuresid }}">{{ measure.ris_name }}</option>
                                {% endfor %}
                            </select>

                        </td>
                    </tr>
                    {% assign rowCounter = rowCounter | plus: 1 %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div style="overflow:auto;">
            <div style="float:right;">
                <button type="button" id="prevBtn" onclick="nextPrev(-1)">Previous</button>
                <button type="button" id="nextBtn" onclick="nextPrev(1)">Next</button>
                <button type="button" id="submitBtn"
                    onclick="nextBtnClick(currentTab+1);submitBtnClick()">Submit</button>
            </div>
        </div>
        <!-- Circles which indicates the steps of the form: -->
        <div style="text-align:center;margin-top:40px;">
            <span class="step"></span>
            <span class="step"></span>
            <span class="step"></span>
            <span class="step"></span>
            <span class="step"></span>
        </div>
        <!-- checkbox for showing risk -->
        <div id="checkboxContainer"></div>
    </form>
    <script>
        var currentTab = 0; // Current tab is set to be the first tab (0)
        showButtons(currentTab); // Display the current tab
        function showButtons(n) {
            // This function will display the specified tab of the form ...
            var x = document.getElementsByClassName("tab");
            x[n].style.display = "block";
            // ... and fix the Previous/Next buttons:
            if (n == 0) {
                document.getElementById("prevBtn").style.display = "none";
                document.getElementById("nextBtn").style.display = "inline";
                document.getElementById("submitBtn").style.display = "none";
            } else {
                document.getElementById("prevBtn").style.display = "inline";

                if (n == (x.length - 1)) {
                    document.getElementById("submitBtn").style.display = "inline";
                    document.getElementById("nextBtn").style.display = "none";
                } else {
                    document.getElementById("nextBtn").style.display = "inline";
                    document.getElementById("submitBtn").style.display = "none";
                }
            }
            
            stepIndication(n)
        }
        function nextPrev(n) {
            
            var x = document.getElementsByClassName("tab");
            // Exit the function if any field in the current tab is invalid:
            if (n == 1 && !formValidation()) return false;
            // Hide the current tab:
            x[currentTab].style.display = "none";         
            currentTab = currentTab + n;
            // if you have reached the end of the form... :
            if (currentTab >= x.length) {      
                document.getElementById("regForm").submit();
                return false;
            }

            showButtons(currentTab);
            nextBtnClick(currentTab);
        }
        function formValidation() {
            var x, y, i, valid = true;
            x = document.getElementsByClassName("tab");
            y = x[currentTab].getElementsByTagName("input");

            for (i = 0; i < y.length; i++) {
                
                if (y[i].value == "") {
                    // add an "invalid" class to the field:
                    y[i].className += " invalid";
                    // and set the current valid status to false:
                    valid = false;
                }
            }
            if (valid) {

                document.getElementsByClassName("step")[currentTab].className += " finish";

            }
            return valid; 
        }
        function stepIndication(n) {
            
            var i, x = document.getElementsByClassName("step");
            for (i = 0; i < x.length; i++) {
                x[i].className = x[i].className.replace(" active", "");
            }
        
            x[n].className += " active";
        }

        function submitFunction() {
            document.getElementById("regForm").submit();
            window.location.reload();
        }


        var recordCreated = false;
        var user = "{{user.fullname}}"
        var userid="{{user.id}}"
        var userName = document.getElementById("nameField");
        console.log(userName);
        if (user && userName) {
            userName.value = user;
        }
        debugger;
        (function (webapi, $) {
            function safeAjax(ajaxOptions) {
                var deferredAjax = $.Deferred();
                shell.getTokenDeferred().done(function (token) {
                    // add headers for AJAX
                    if (!ajaxOptions.headers) {
                        $.extend(ajaxOptions, {
                            headers: {
                                "__RequestVerificationToken": token
                            }
                        });
                    } else {
                        ajaxOptions.headers["__RequestVerificationToken"] = token;
                    }
                    $.ajax(ajaxOptions)
                        .done(function (data, textStatus, jqXHR) {
                            validateLoginSession(data, textStatus, jqXHR, deferredAjax.resolve);
                        }).fail(deferredAjax.reject); //AJAX
                }).fail(function () {
                    deferredAjax.rejectWith(this, arguments); // on token failure pass the token AJAX and args
                });
                return deferredAjax.promise();
            }
            webapi.safeAjax = safeAjax;
        })(window.webapi = window.webapi || {}, jQuery)

        var formData = [];
        //var currenTab;
        //document.getElementById("nextBtn").addEventListener("click", function(){
        function nextBtnClick(currentTab) {
            debugger;
            var categoryName;

            var risk, parentTR;
            var measures, measureSelected;
            var transactionRisk = [];
            var transactionMeasure = [];
            var transactionCategory = [];

            var checkboxes = document.querySelectorAll('input:checked');
            console.log(checkboxes);

            checkboxes.forEach(function (checkbox) {
                category = checkbox.getAttribute("data-category");
                parentTR = checkbox.closest("tr");
                risk = parentTR.querySelector("td:nth-child(2)").textContent;
                measures = parentTR.querySelector("select");
                measureSelected = measures.options[measures.selectedIndex].textContent;
                console.log(measureSelected);

                transactionRisk.push(risk);
                transactionMeasure.push(measureSelected);
                transactionCategory.push(category);

                formData[currentTab] = {
                    transactionRisk: transactionRisk,
                    transactionMeasure: transactionMeasure,
                    transactionCategory: transactionCategory
                };
                console.log(transactionRisk);
                console.log(transactionMeasure);
                console.log(transactionCategory);
            });
        }
        //});

        //document.getElementById("submitBtn").addEventListener("click", function () {
        function submitBtnClick() {
            debugger;
        
            // Get the name input field value
            var nameValue = document.getElementById('nameField').value;
            contactId=userid;
            // Create the record object
            var record = {
                ris_name: nameValue
            };
            // Setting lookup value to contact
            record["ris_Contact@odata.bind"]="/contacts("+ contactId + ")";
            // Make the web API request to submit the data
            webapi.safeAjax({
                type: "POST",
                contentType: "application/json",
                url: "/_api/ris_riskprofileses",
                data: JSON.stringify(record),
                success: function (data, textStatus, xhr) {
                    var newId = xhr.getResponseHeader("entityid");
                    console.log(newId);
                    // Optionally, you can perform actions after successful submission
                    var storeCategory, storeRisk, storeMeasure;

                    console.log(formData[3]);
                    console.log(formData[5].transactionCategory);
                    console.log(formData[5].transactionMeasure);
                    console.log(formData[5].transactionRisk);

                    if (formData[5]) {
                        var selectedCategoryStep = formData[5].transactionCategory;
                        var selectedRiskStep = formData[5].transactionRisk;
                        var selectedMeasureStep = formData[5].transactionMeasure;

                        for (i = 0; i < selectedRiskStep.length; i++) {
                            storeCategory = selectedCategoryStep[i];
                            storeRisk = selectedRiskStep[i];
                            storeMeasure = selectedMeasureStep[i];

                            var record = {};
                            record.ris_name = nameValue;
                            record.ris_measure = storeMeasure;
                            record.ris_riskcategory = storeCategory;
                            record.ris_risk = storeRisk;

                            record["ris_RiskProfile@odata.bind"] = "/ris_riskprofileses(" + newId + ")";

                            webapi.safeAjax({
                                type: "POST",
                                contentType: "application/json",
                                url: "/_api/ris_transactionses",
                                data: JSON.stringify(record),
                                success: function (data, textStatus, xhr) {
                                    var newId1 = xhr.getResponseHeader("entityid");
                                    console.log(newId1);
                                    // Optionally, you can perform actions after successful submission
                                },
                                error: function (xhr, textStatus, errorThrown) {
                                    console.log(xhr);
                                    // Handle errors if needed
                                }
                            });
                        }
                    }
                    window.location.reload();
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log(xhr);
                    // Handle errors if needed
                    window.location.reload();
                }
                
            });
        }
    </script>
</body>

</html>