<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Created risk profiles</title>
</head>
<style>
    .table-set {
        border: 1px solid #ddd;
        /* Border around the container */
        padding: 10px;
        /* Padding inside the container */
        width: 80%;
        /* Adjust the width as needed */
        margin: 0 auto;
        /* Center the container on the page */
        box-shadow: 0px 0px 5px #888;
    }

    /* Style the table */
    table {
        border-collapse: collapse;
        width: 100%;
    }

    /* Style table header */
    th {
        background-color: #f2f2f2;
        font-weight: bold;
        text-align: left;
        padding: 8px;
    }

    /* Style table rows */
    tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    tr:nth-child(odd) {
        background-color: #f2f2f2;
    }

    /* Style table data cells */
    td {
        padding: 8px;
    }

    /* Hover effect on rows */
    tr:hover {
        background-color: #ddd;
    }

    .redirect {
        margin-left: 80%;
        margin-top: 10px;
        padding-left: 20px;
        padding-right: 20px;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 5px;
        width: 60%;
        max-width: 600px;
        margin: 100px auto;
        padding: 20px;
        position: relative;
    }

    .close {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 20px;
        cursor: pointer;
    }

    button:hover {
        background-color: #e58700;
    }

    button {
        background-color: #2e456b;
        color: white;
        width: 80px;
        height: 35px;
        border-radius: 20%;
    }
</style>

<body>
    <button type="button" class="redirect" id="redirectToFormPage" style="display: flex; justify-content: center; align-items: center;">Create</button>

    <div class="table-set">
        <h2>List of Risk Profiles</h2>


        <!-- fetching the value of risk profiles table -->
        {% fetchxml measures %}
        <fetch version="1.0" mapping="logical" no-lock="false" distinct="true">
            <entity name="ris_riskprofiles">
                <attribute name="ris_riskprofilesid" />
                <attribute name="ris_name" />
                <attribute name="ris_riskname" />
                <attribute name="ris_measures" />
                <attribute name="ris_riskstatus" />
                <order attribute="ris_name" descending="false" />
                <filter type="and">
                    <condition attribute="ris_name" operator="eq" value="{{ user.fullname }}" />
                </filter>
            </entity>
        </fetch>
        {% endfetchxmlâ€¯%}

        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Status</th>
                    <th>View</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                {% assign rowCounter = 1 %} {% for result in measures.results.entities %}

                <tr class="dynamic-color">
                    <td>{{ result.ris_name }}</td>
                    <td>{{ result.ris_riskstatus.label }}</td>
                    <td>
                        <button type="button" class="view-button" style="display: flex; justify-content: center; align-items: center;" data-toggle="modal" data-target="#viewModal"
                            data-trid="{{ result.ris_riskprofilesid }}" onclick="viewBtn(this)">View</button>
                    </td>
                    <td>
                        <button type="button" class="delete-button" style="display: flex; justify-content: center; align-items: center;"
                            onclick="deleteBtn('{{ result.ris_riskprofilesid }}')">
                            <b>Delete</b>
                        </button>
                    </td>
                </tr>
                {% assign rowCounter=rowCounter | plus:1 %} {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="viewModal" class="modal">
        <div class="modal-content" style="background-color: rgb(245, 197, 64);">
            <h4 class="modal-title">View Details</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" readonly />
                    </div>

                    <div class="form-group">
                        <label for="status" class="form-label">Status</label>
                        <input type="text" class="form-control" id="status" readonly />
                    </div>
                </form>

                <table>
                    <thead>
                        <tr>
                            <th>Risk Category</th>
                            <th>Risk</th>
                            <th>Measures</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>


                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
      debugger;
        document.addEventListener("DOMContentLoaded", function () {
            var rows = document.querySelectorAll(".dynamic-color");
            var riskStatusLabel;
            rows.forEach(function (row) {
                riskStatusLabel = row.querySelector("td:nth-child(2)").textContent.trim();
                var hue;
                if (riskStatusLabel === "Approved") {
                    hue = 100;
                } else if (riskStatusLabel === "Rejected") {
                    hue = 10;
                } else {
                    hue = 70;
                }

                row.style.backgroundColor = "hsl(" + hue + ", 80%, 60%)";
            });
        });

        document.getElementById("redirectToFormPage").addEventListener("click", function () {
            window.location.href = "https://riskprofilingsystem.powerappsportals.com/RiskProfiles/";
        });

        (function (webapi, $) {
            function safeAjax(ajaxOptions) {
                var deferredAjax = $.Deferred();
                shell.getTokenDeferred().done(function (token) {
                    // add headers for AJAX
                    if (!ajaxOptions.headers) {
                        $.extend(ajaxOptions, {
                            headers: {
                                "__RequestVerificationToken": token
                            }
                        });
                    } else {
                        ajaxOptions.headers["__RequestVerificationToken"] = token;
                    }
                    $.ajax(ajaxOptions)
                        .done(function (data, textStatus, jqXHR) {
                            validateLoginSession(data, textStatus, jqXHR, deferredAjax.resolve);
                        }).fail(deferredAjax.reject); //AJAX
                }).fail(function () {
                    deferredAjax.rejectWith(this, arguments); // on token failure pass the token AJAX and args
                });
                return deferredAjax.promise();
            }
            webapi.safeAjax = safeAjax;
        })(window.webapi = window.webapi || {}, jQuery);

        function viewBtn(button) {

            debugger;

            var trId = button.getAttribute("data-trid");
            var ris_name;

            webapi.safeAjax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                url: "/_api/ris_riskprofileses?$select=ris_riskprofilesid,ris_name,ris_riskstatus&$filter=ris_riskprofilesid eq (" + trId + ")",
                headers: {
                    Prefer: "odata.include-annotations=*"
                },
                success: function (data, textStatus, xhr) {
                    // the row will be present on deleting the record
                    var results = data;

                    for (var i = 0; i < results.value.length; i++) {
                        var result = results.value[i];
                        var ris_riskprofilesid = result["ris_riskprofilesid"];
                        ris_name = result["ris_name"];
                        //here profile status is a option set !!
                        var ris_profilestatus_value = result["ris_riskstatus@OData.Community.Display.V1.FormattedValue"];

                        document.getElementById("name").value = ris_name;
                        document.getElementById("status").value = ris_profilestatus_value;
                    }
                    // Retrieving value from related transaction record
                    webapi.safeAjax({
                        type: "GET",
                        contentType: "application/json",
                        url: "/_api/ris_transactionses?$select=ris_transactionsid,ris_measure,ris_name,ris_risk,ris_riskcategory,_ris_riskprofile_value&$filter=_ris_riskprofile_value eq (" + trId + ")",
                        headers: {
                            Prefer: "odata.include-annotations=*",
                        },
                        success: function (data, textStatus, xhr) {
                            var results = data;
                            var i = 0;
                            var tableBody = document.querySelector("#viewModal table tbody");
                            tableBody.innerHTML = "";
                            console.log(results);

                            for (i = 0; i < results.value.length; i++) {
                                var result = results.value[i];

                                var ris_transactionsid = result["ris_transactionsid"];
                                var ris_riskcategory = result["ris_riskcategory"];
                                var ris_risk = result["ris_risk"];
                                var ris_name = result["ris_name"];
                                var ris_measure = result["ris_measure"];

                                var newRow = document.createElement("tr");
                                newRow.innerHTML = `
                                    <td>${ris_riskcategory}</td>
                                    <td>${ris_risk}</td>
                                    <td>${ris_measure}</td>
                                `;

                                tableBody.appendChild(newRow);
                            }
                        },
                        error: function (xhr, textStatus, errorThrown) {

                            console.log(xhr);

                        },
                    });
                },

                error: function (xhr, textStatus, errorThrown) {

                    console.log(xhr);


                },

            });
            //alert("Test");
        }


        function deleteBtn(profileId) {
            debugger;

            var rowid = profileId;
            console.log(rowid);

            if (confirm("Do you want to delete this record")) {
                webapi.safeAjax({
                    type: "GET",
                    url: "/_api/ris_transactionses?$filter=_ris_riskprofile_value eq (" + rowid + ")",
                    contentType: "application/json",
                    headers: {
                        "Prefer": "odata.include-annotations=*"
                    },
                    success: function (data, textStatus, xhr) {
                        var results = data;
                        console.log(results);
                        for (var i = 0; i < results.value.length; i++) {
                            var result = results.value[i];
                            // Columns
                            var ris_transactionsid = result["ris_transactionsid"]; // Guid

                            webapi.safeAjax({
                                type: "DELETE",
                                url: "/_api/ris_transactionses(" + ris_transactionsid + ")",
                                contentType: "application/json",
                                success: function (data, textStatus, xhr) {
                                    console.log("Record deleted");
                                },
                                error: function (xhr, textStatus, errorThrown) {
                                    console.log(xhr);
                                }
                            });
                        }
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        console.log(xhr);
                    }
                });

                webapi.safeAjax({
                    type: "DELETE",
                    url: "/_api/ris_riskprofileses("+ rowid +")",
                    contentType: "application/json",
                    success: function (data, textStatus, xhr) {
                        console.log("Record deleted");

                        var row=document.querySelector(`tr[data-rowid="${rowid}"]`);
                        if(row && row.parentNode){
                            var parent=row.parentNode;
                            parent.removeChild(row);
                            console.log("Deleted record");
                        }else{
                            console.warn("row not found");
                        }

                        window.location.reload();
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        console.log(xhr);
                        window.location.reload();
                    }
                });

                var modal=document.getElementById("viewModal");

                var viewButton=document.getElementById("view");

                // When user clicks anywhere outside of the model, close it
                window.onclick=function(event){
                    if(event.target === modal){
                        modal.style.display="none";
                    }
                };
            }
        }


    </script>

</body>

</html>